; -*-scheme-*-
; stress gc of model objects

(use-modules (oop goops)
	     (burrow spectrum)
	     (burrow canvas)
	     (burrow model))

(sleep-if-requested)

(define (gaussian-profile-1d f sigma)
  (model-gaussian (make <hos-model-dimension>) f sigma))

(define (gaussian-2d x wx y wy intensity)
  (model-product
   (model-product
    (gaussian-profile-1d x wx)
    (gaussian-profile-1d y wy))
   intensity))

(define line-plot (make <hos-spectrum-profile>))
(define spec #f)

(define (go!)
  (let ((x (make <hos-parameter> #:value 5))
	(wx (make <hos-parameter> #:value 15))
	(y (make <hos-parameter> #:value 120))
	(wy (make <hos-parameter> #:value 10))
	(intensity (make <hos-parameter> #:value 10)))
    (set! spec
	  (spectrum-1d-from-model 
	   (model-project (gaussian-2d x wx y wy intensity) 100)
	   0 100 512))
    (set line-plot 'spectrum spec)
    'ok))

(do ((i 0 (+ i 1)))
    ((> i 10000))
  (if (= 0 (remainder i 100))(display "."))
  (go!))
(newline)

